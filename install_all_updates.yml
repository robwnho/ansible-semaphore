---
- name: Executar atualização via tarefa agendada distribuída por GPO
  hosts: all
  gather_facts: no
  vars:
    task_name: "AtualizarComPS7"

  tasks:

    - name: Forçar aplicação da GPO com gpupdate /force
      win_shell: gpupdate /force

    - name: Esperar 10 segundos para GPO aplicar tarefas agendadas
      pause:
        seconds: 10

    - name: Iniciar a tarefa agendada de atualização
      win_shell: |
        Start-ScheduledTask -TaskName "{{ task_name }}"

    - name: Aguardar a conclusão da tarefa AtualizarComPS7 (modo resiliente)
      win_shell: '
        $maxWait = 60
        $counter = 0
        do {
          try {
            $taskInfo = Get-ScheduledTaskInfo -TaskName "AtualizarComPS7" -ErrorAction Stop
            $status = $taskInfo.State
            Write-Host "Status da tarefa: $status"
            if ($status -eq "Ready") {
              break
            }
          } catch {
            Write-Host "Tarefa ainda não disponível. Aguardando..."
          }
          Start-Sleep -Seconds 30
          $counter++
        } while ($counter -lt $maxWait)
      '
      args:
        executable: powershell.exe


    - name: (Opcional) Reiniciar o host após atualização
      win_reboot:
        reboot_timeout: 3600

    - name: Mensagem final
      debug:
        msg: "Atualização executada com sucesso via tarefa agendada."
